<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Alky</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --accent: #ff4d4d; --soft: #888; --border: #eeeeee; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 20px; padding-top: 60px; display: flex; flex-direction: column; align-items: center; background: #fff; }
        
        #header { text-align: center; margin-bottom: 25px; }
        #day-counter { font-size: 0.7rem; letter-spacing: 2px; color: var(--soft); font-weight: bold; text-transform: uppercase; }
        .heart-pulse { display: inline-block; color: var(--accent); font-size: 1rem; animation: heartBeat 1.2s infinite; cursor: pointer; }
        @keyframes heartBeat { 0% { transform: scale(1); } 14% { transform: scale(1.3); } 28% { transform: scale(1); } 42% { transform: scale(1.3); } 70% { transform: scale(1); } }

        .section { width: 100%; max-width: 400px; margin-bottom: 20px; }
        .mood-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .mood-box { border: 1px solid var(--border); padding: 15px; text-align: center; border-radius: 10px; cursor: pointer; }
        .mood-box span { font-size: 1.5rem; display: block; }
        .mood-box p { margin: 5px 0 0 0; font-size: 0.6rem; color: var(--soft); font-weight: bold; }

        #viewport { width: 100%; aspect-ratio: 1/1; border: 1px solid var(--border); background: #f0f0f0; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; border-radius: 12px; }
        video, #preview-img { width: 100%; height: 100%; object-fit: cover; }
        
        .cam-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn { width: 100%; padding: 14px; border: 1px solid #000; background: #fff; font-size: 0.7rem; cursor: pointer; text-transform: uppercase; font-weight: bold; border-radius: 8px; }
        .btn-black { background: #000; color: #fff; }

        textarea { width: 100%; border: none; border-bottom: 1px solid var(--border); margin: 15px 0; padding: 10px 0; outline: none; font-size: 1rem; }

        /* TIMELINE */
        #timeline { width: 100%; max-width: 400px; margin-top: 20px; }
        .entry { margin-bottom: 40px; border-bottom: 1px solid #f0f0f0; padding-bottom: 20px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .entry-img { width: 100%; border-radius: 10px; margin-bottom: 12px; }
        .author-tag { font-weight: bold; font-size: 0.8rem; color: var(--accent); margin-bottom: 5px; display: block; }
        
        .comment-section { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.85rem; }
        .reply-btn { background: none; border: none; color: #007aff; font-size: 0.75rem; font-weight: bold; cursor: pointer; margin-top: 5px; }
        #toast { position: fixed; top: 20px; background: #333; color: #fff; padding: 10px 20px; border-radius: 50px; font-size: 0.7rem; display: none; z-index: 9999; }
    </style>
</head>
<body>

<div id="toast">Sent!</div>

<div id="header">
    <div id="day-counter">Counting... <span class="heart-pulse" onclick="iamHere()">‚ô•</span></div>
    <div style="font-size: 0.5rem; color: #bbb; margin-top: 10px; cursor: pointer;" onclick="resetIdentity()">Tap to Switch User</div>
</div>

<div class="section">
    <div class="mood-grid">
        <div class="mood-box" onclick="quickLog('üòä', 'Happy')"><span>üòä</span><p>Happy</p></div>
        <div class="mood-box" onclick="quickLog('üò§', 'Mad')"><span>üò§</span><p>Mad</p></div>
        <div class="mood-box" onclick="quickLog('‚òÅÔ∏è', 'Sad')"><span>‚òÅÔ∏è</span><p>Sad</p></div>
        <div class="mood-box" onclick="quickLog('ü´Ç', 'Miss You')"><span>ü´Ç</span><p>Miss You</p></div>
        <div class="mood-box" onclick="quickLog('üßò', 'Space')"><span>üßò</span><p>Space</p></div>
        <div class="mood-box" onclick="quickLog('üí¨', 'Talk')"><span>üí¨</span><p>Talk</p></div>
    </div>
</div>

<div class="section">
    <div id="viewport">
        <video id="v" autoplay playsinline muted style="display:none;"></video>
        <img id="preview-img" style="display:none;">
        <span id="cam-label">Camera Standby</span>
    </div>
    <div class="cam-controls">
        <button class="btn" id="open-btn" onclick="startCamera('user')" style="grid-column: span 2;">Open Camera</button>
        <button id="snap-btn" class="btn btn-black" style="display:none;" onclick="takePhoto()">Snap</button>
        <button id="flip-btn" class="btn" style="display:none;" onclick="flipCamera()">Flip</button>
        <button id="close-btn" class="btn" style="display:none; grid-column: span 2;" onclick="stopCamera()">X</button>
    </div>
    <textarea id="msg-input" placeholder="Add a caption..."></textarea>
    <button class="btn btn-black" onclick="postNow()">Post to Timeline</button>
</div>

<div id="timeline"><div id="list"></div></div>

<script>
    // 1. DATABASE SETUP
    const firebaseConfig = { databaseURL: "https://alky-bd03f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('shared_timeline_v3'); // Forced fresh sync folder

    // 2. IDENTITY
    let userRole = localStorage.getItem('alky_user');
    if (!userRole) {
        userRole = confirm("Is this CD?") ? 'CD' : 'Nadine';
        localStorage.setItem('alky_user', userRole);
    }

    // 3. EMAIL/NOTIFY
    (function() { emailjs.init("w-7MpanHNsBrGh6vo"); })();
    function notify(msg) {
        const toast = document.getElementById('toast');
        toast.style.display = 'block';
        const target = (userRole === 'CD') ? "aprilsia00@gmail.com" : "sarmientoclairedean@gmail.com";
        emailjs.send("service_5zrzgge", "template_dj834xq", { mood: msg, send_to: target, time: new Date().toLocaleTimeString() })
        .then(() => { toast.innerText = "Sent!"; setTimeout(()=> toast.style.display='none', 2000); });
    }

    // 4. THE HEART (Connection Hub)
    function iamHere() { notify("I'm here! ‚ô•"); alert("Heart ping sent!"); }

    // 5. LIVE SYNC (The most important part)
    db.on('value', (snapshot) => {
        const list = document.getElementById('list');
        list.innerHTML = '';
        const data = snapshot.val();
        if(!data) return;

        // Display posts newest to oldest
        Object.keys(data).reverse().forEach(key => {
            const item = data[key];
            const div = document.createElement('div');
            div.className = 'entry';
            
            let comments = '';
            if(item.replies) {
                comments = `<div class="comment-section">`;
                Object.values(item.replies).forEach(r => {
                    comments += `<div><b>${r.by}:</b> ${r.text}</div>`;
                });
                comments += `</div>`;
            }

            div.innerHTML = `
                ${item.image ? `<img src="${item.image}" class="entry-img">` : ''}
                <span class="author-tag">${item.author}</span>
                <div style="font-size:1rem;">${item.mood ? item.mood + ' ' : ''}${item.text || ''}</div>
                <div style="font-size:0.6rem; color:#bbb; margin-top:5px;">${item.time}</div>
                <button class="reply-btn" onclick="addReply('${key}')">Reply</button>
                ${comments}
            `;
            list.appendChild(div);
        });
    });

    // 6. POSTING LOGIC
    function quickLog(emoji, label) {
        db.push({ mood: emoji, text: label, author: userRole, time: new Date().toLocaleString() });
        notify(emoji + " " + label);
    }

    function postNow() {
        const txt = document.getElementById('msg-input').value;
        const img = capturedImg;
        if(!txt && !img) return;
        
        db.push({
            author: userRole,
            text: txt,
            image: img,
            time: new Date().toLocaleString(),
            timestamp: Date.now()
        }).then(() => {
            notify("New Post!");
            document.getElementById('msg-input').value = "";
            stopCamera();
            capturedImg = null;
            document.getElementById('preview-img').style.display='none';
        });
    }

    function addReply(id) {
        const r = prompt("Your reply:");
        if(!r) return;
        db.child(id).child('replies').push({ by: userRole, text: r });
        notify("üí¨ Reply: " + r);
    }

    // 7. CAMERA
    const v = document.getElementById('v');
    const preview = document.getElementById('preview-img');
    let stream = null; let capturedImg = null; let mode = "user";

    async function startCamera(m) {
        if(stream) stopCamera();
        mode = m;
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
            v.srcObject = stream; v.style.display = 'block';
            document.getElementById('open-btn').style.display = 'none';
            document.getElementById('snap-btn').style.display = 'block';
            document.getElementById('flip-btn').style.display = 'block';
            document.getElementById('close-btn').style.display = 'block';
        } catch(e) { alert("Camera error."); }
    }

    function flipCamera() { startCamera(mode === "user" ? "environment" : "user"); }

    function stopCamera() {
        if(stream) stream.getTracks().forEach(t => t.stop());
        v.style.display = 'none'; document.getElementById('open-btn').style.display = 'block';
        document.getElementById('snap-btn').style.display = 'none'; 
        document.getElementById('flip-btn').style.display = 'none';
        document.getElementById('close-btn').style.display = 'none';
    }

    function takePhoto() {
        const canvas = document.createElement('canvas');
        canvas.width = v.videoWidth; canvas.height = v.videoHeight;
        const ctx = canvas.getContext('2d');
        if(mode === "user") { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }
        ctx.drawImage(v, 0, 0);
        capturedImg = canvas.toDataURL('image/jpeg', 0.5);
        preview.src = capturedImg; preview.style.display = 'block';
        stopCamera();
    }

    function resetIdentity() { localStorage.removeItem('alky_user'); location.reload(); }
    
    // Day Counter
    const diff = Math.floor((new Date() - new Date("2025-08-12")) / (1000 * 60 * 60 * 24)) + 1;
    document.getElementById('day-counter').innerHTML = `Day ${diff} of Us <span class="heart-pulse" onclick="iamHere()">‚ô•</span>`;
</script>
</body>
</html>
