<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Alky</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.imgur.com/your-icon-link.png">

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --bg: #ffffff; --text: #1a1a1a; --border: #eeeeee; --soft: #888; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 20px; padding-top: 60px; display: flex; flex-direction: column; align-items: center; }
        
        #header { text-align: center; margin-bottom: 30px; }
        #day-counter { font-size: 0.65rem; letter-spacing: 3px; color: var(--soft); text-transform: uppercase; font-weight: bold; }
        #daily-prompt { font-size: 0.85rem; margin-top: 8px; font-style: italic; color: #555; max-width: 300px; }

        .section { width: 100%; max-width: 400px; margin-bottom: 30px; }
        .mood-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .mood-box { border: 1px solid var(--border); padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .mood-box:active { background: #f0f0f0; }
        .mood-box span { font-size: 1.5rem; display: block; }
        .mood-box p { margin: 5px 0 0 0; font-size: 0.6rem; color: var(--soft); font-weight: bold; }

        #viewport { width: 100%; aspect-ratio: 1/1; border: 1px solid var(--border); background: #000; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; border-radius: 4px; }
        video, #preview-img { width: 100%; height: 100%; object-fit: cover; }
        
        .cam-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn { width: 100%; padding: 14px; border: 1px solid var(--text); background: #fff; font-size: 0.75rem; cursor: pointer; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }
        .btn-black { background: #000; color: #fff; }
        .btn-full { grid-column: span 2; }

        textarea { width: 100%; border: none; border-bottom: 1px solid var(--border); margin-top: 15px; padding: 12px 0; outline: none; font-family: inherit; font-size: 1rem; box-sizing: border-box; }

        #timeline { width: 100%; max-width: 400px; margin-top: 40px; border-top: 1px solid var(--border); padding-top: 20px; }
        .entry { margin-bottom: 35px; position: relative; border-bottom: 1px solid #f9f9f9; padding-bottom: 15px; }
        .entry-img { width: 100%; border-radius: 4px; margin-bottom: 12px; }
        .del-btn { position: absolute; right: 0; top: 0; background: none; border: none; color: #eee; cursor: pointer; font-size: 1.2rem; }

        .entry-footer { display: flex; align-items: flex-start; gap: 12px; }
        .entry-mood { font-size: 1.4rem; }
        .entry-text { font-size: 0.95rem; color: #333; line-height: 1.4; flex: 1; }
        .entry-time { font-size: 0.7rem; color: #bbb; margin-top: 4px; display: block; }
        .author-tag { font-weight: bold; font-size: 0.75rem; color: #1a1a1a; display: block; margin-bottom: 2px; }

        #toast { position: fixed; top: 20px; background: #333; color: #fff; padding: 10px 20px; border-radius: 50px; font-size: 0.7rem; display: none; z-index: 1000; }
        #identity-banner { font-size: 0.6rem; color: var(--soft); margin-top: 10px; cursor: pointer; }

        /* The Pulse Heart */
.heart-pulse {
    display: inline-block;
    color: #ff4d4d;
    font-size: 0.8rem;
    margin-left: 5px;
    animation: heartBeat 1.2s infinite;
}

@keyframes heartBeat {
    0% { transform: scale(1); }
    14% { transform: scale(1.3); }
    28% { transform: scale(1); }
    42% { transform: scale(1.3); }
    70% { transform: scale(1); }
}
    </style>
</head>
<body>

    <div id="toast">Notifying...</div>

   <div id="header">
    <div id="day-counter">Counting... <span class="heart-pulse">‚ô•</span></div>
    <div id="daily-prompt">‚ÄúTake a photo of where you are right now.‚Äù</div>
    <div id="identity-banner" onclick="resetIdentity()">Settings</div>
</div>

    <div class="section">
        <div class="mood-grid">
            <div class="mood-box" onclick="quickLog('üòä', 'feeling happy')"><span>üòä</span><p>Happy</p></div>
            <div class="mood-box" onclick="quickLog('üò§', 'feeling mad')"><span>üò§</span><p>Mad</p></div>
            <div class="mood-box" onclick="quickLog('‚òÅÔ∏è', 'feeling sad')"><span>‚òÅÔ∏è</span><p>Sad</p></div>
            <div class="mood-box" onclick="quickLog('ü´Ç', 'missing you')"><span>ü´Ç</span><p>Miss You</p></div>
            <div class="mood-box" onclick="quickLog('üßò', 'needs space')"><span>üßò</span><p>Space</p></div>
            <div class="mood-box" onclick="quickLog('üí¨', 'lets talk')"><span>üí¨</span><p>Talk</p></div>
        </div>
    </div>

    <div class="section">
        <div id="viewport">
            <video id="v" autoplay playsinline muted style="display:none;"></video>
            <img id="preview-img" style="display:none;">
            <span id="cam-label" style="color:#666; font-size:0.7rem;">CAMERA OFF</span>
        </div>
        <div class="cam-controls">
            <button class="btn btn-full" id="main-cam-btn" onclick="startStream()">Open Camera</button>
            <button id="flip-btn" class="btn" style="display:none;" onclick="flipCamera()">Flip</button>
            <button id="close-btn" class="btn" style="display:none;" onclick="stopCamera()">Close</button>
            <button id="snap-btn" class="btn btn-black btn-full" style="display:none;" onclick="captureImage()">Capture</button>
        </div>
        <textarea id="msg-input" placeholder="Message..."></textarea>
        <button class="btn btn-black" onclick="submitEntry()">Post to Timeline</button>
    </div>

    <div id="timeline"><div id="list"></div></div>

    <script>
        // --- 1. FIREBASE SETUP (REQUIRED FOR SHARED TIMELINE) ---
        const firebaseConfig = {
            databaseURL: "https://alky-bd03f-default-rtdb.asia-southeast1.firebasedatabase.app/" // <--- PASTE YOUR FIREBASE URL HERE
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('alky_timeline');

        // --- 2. EMAILJS CONFIGURATION ---
        (function() { emailjs.init("w-7MpanHNsBrGh6vo"); })();
        const SERVICE_ID = "service_5zrzgge";
        const TEMPLATE_ID = "template_dj834xq";
        const MY_EMAIL = "sarmientoclairedean@gmail.com";
        const HER_EMAIL = "aprilsia00@gmail.com";

        const startDate = new Date("2025-08-12"); 
        let userRole = localStorage.getItem('alky_role');

        const v = document.getElementById('v');
        const previewImg = document.getElementById('preview-img');
        const list = document.getElementById('list');
        let stream = null;
        let capturedBase64 = null;
        let currentFacingMode = "user";

        window.onload = () => {
            if (!userRole) {
                const choice = confirm("Set up Alky: Is this YOUR phone? (OK = Him, Cancel = Her)");
                userRole = choice ? 'me' : 'her';
                localStorage.setItem('alky_role', userRole);
            }
            document.getElementById('identity-banner').innerText = `Role: ${userRole === 'me' ? 'Him' : 'Her'} (Tap to Reset)`;
            
            const today = new Date();
            const diffDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('day-counter').innerText = `Day ${diffDays} of Us`;

            // Listen for Shared Timeline Updates
            db.on('value', (snapshot) => {
                const data = snapshot.val();
                loadSharedHistory(data);
            });
        };

        function resetIdentity() {
            if(confirm("Change identity?")) {
                localStorage.removeItem('alky_role');
                location.reload();
            }
        }

        function notify(mood) {
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            toast.innerText = "Notifying...";
            const recipient = (userRole === 'me') ? HER_EMAIL : MY_EMAIL;
            const params = { mood: mood, send_to: recipient, time: new Date().toLocaleTimeString() };
            emailjs.send(SERVICE_ID, TEMPLATE_ID, params).then(() => {
                toast.innerText = "Notified " + (userRole === 'me' ? "her" : "him");
                setTimeout(() => toast.style.display = 'none', 2000);
            });
        }

        async function startStream() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
                v.srcObject = stream; v.style.display = 'block'; previewImg.style.display = 'none';
                document.getElementById('main-cam-btn').style.display = 'none';
                document.getElementById('flip-btn').style.display = 'block';
                document.getElementById('close-btn').style.display = 'block';
                document.getElementById('snap-btn').style.display = 'block';
                document.getElementById('cam-label').style.display = 'none';
                v.style.transform = (currentFacingMode === "user") ? "scaleX(-1)" : "scaleX(1)";
            } catch (err) { alert("Camera error."); }
        }

        function flipCamera() { currentFacingMode = (currentFacingMode === "user") ? "environment" : "user"; startStream(); }
        function stopCamera() { if (stream) stream.getTracks().forEach(t => t.stop()); stream = null; v.style.display = 'none'; document.getElementById('main-cam-btn').style.display = 'block'; document.getElementById('flip-btn').style.display = 'none'; document.getElementById('close-btn').style.display = 'none'; document.getElementById('snap-btn').style.display = 'none'; document.getElementById('cam-label').style.display = 'block'; }
        function captureImage() { const canvas = document.createElement('canvas'); canvas.width = v.videoWidth; canvas.height = v.videoHeight; const ctx = canvas.getContext('2d'); if(currentFacingMode === "user") { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); } ctx.drawImage(v, 0, 0); capturedBase64 = canvas.toDataURL('image/jpeg', 0.8); previewImg.src = capturedBase64; previewImg.style.display = 'block'; stopCamera(); }

        function quickLog(emoji, text) { 
            notify(emoji + " " + text); 
            saveToFirebase({ mood: emoji, text: text, img: null }); 
        }

        function submitEntry() {
            const text = document.getElementById('msg-input').value;
            if (!text && !capturedBase64) return;
            notify(text ? "üíå Sent a message" : "üì∏ Sent a photo");
            saveToFirebase({ mood: 'üíå', text: text, img: capturedBase64 });
            document.getElementById('msg-input').value = ""; previewImg.style.display = 'none'; capturedBase64 = null;
        }

        function saveToFirebase(data) {
            const newItem = { 
                ...data, 
                author: userRole,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + ' ‚Ä¢ ' + new Date().toLocaleDateString([], { month: 'short', day: 'numeric' }),
                timestamp: Date.now() 
            };
            db.push(newItem);
        }

        function loadSharedHistory(data) {
            list.innerHTML = '';
            if (!data) return;
            const entries = Object.keys(data).map(key => data[key]).reverse();
            entries.forEach(item => {
                const div = document.createElement('div');
                div.className = 'entry';
                const authorLabel = item.author === 'me' ? 'Him' : 'Her';
                div.innerHTML = `
                    ${item.img ? `<img src="${item.img}" class="entry-img">` : ''}
                    <div class="entry-footer"><div class="entry-mood">${item.mood}</div>
                    <div class="entry-text">
                        <span class="author-tag">${authorLabel}</span>
                        ${item.text}<span class="entry-time">${item.time}</span>
                    </div></div>`;
                list.appendChild(div);
            });
        }
    </script>
</body>
</html>
