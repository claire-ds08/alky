<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Alky</title>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --bg: #ffffff; --text: #1a1a1a; --border: #eeeeee; --soft: #888; --accent: #ff4d4d; --link: #007aff; }
        
        /* Layout Fix */
        body, html { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, system-ui, sans-serif; }
        body { display: flex; flex-direction: column; background: var(--bg); }

        /* FIXED TOP SECTION */
        #top-container {
            flex-shrink: 0; /* Prevents this from shrinking */
            padding: 20px;
            padding-top: 50px;
            background: #fff;
            border-bottom: 2px solid #f0f0f0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #header { text-align: center; margin-bottom: 15px; }
        #day-counter { font-size: 0.65rem; letter-spacing: 2px; color: var(--soft); text-transform: uppercase; font-weight: bold; }
        .heart-pulse { display: inline-block; color: var(--accent); font-size: 0.9rem; animation: heartBeat 1.2s infinite; cursor: pointer; }
        @keyframes heartBeat { 0% { transform: scale(1); } 14% { transform: scale(1.3); } 28% { transform: scale(1); } 42% { transform: scale(1.3); } 70% { transform: scale(1); } }

        .section { width: 100%; max-width: 400px; margin-bottom: 10px; }
        .mood-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .mood-box { border: 1px solid var(--border); padding: 8px; text-align: center; border-radius: 8px; cursor: pointer; }
        .mood-box span { font-size: 1.1rem; display: block; }
        .mood-box p { margin: 2px 0 0 0; font-size: 0.5rem; color: var(--soft); text-transform: uppercase; }

        #viewport { width: 100%; aspect-ratio: 16/9; border: 1px solid var(--border); background: #000; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; border-radius: 4px; }
        video, #preview-img { width: 100%; height: 100%; object-fit: cover; }
        
        .cam-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
        .btn { width: 100%; padding: 12px; border: 1px solid var(--text); background: #fff; font-size: 0.7rem; cursor: pointer; text-transform: uppercase; font-weight: bold; }
        .btn-black { background: #000; color: #fff; }

        textarea { width: 100%; border: none; border-bottom: 1px solid var(--border); margin-top: 8px; padding: 8px 0; outline: none; font-size: 0.9rem; }

        /* THE SCROLLABLE TIMELINE */
        #timeline { 
            flex-grow: 1; /* Takes up all remaining screen space */
            overflow-y: auto; 
            padding: 20px;
            background: #fafafa;
            -webkit-overflow-scrolling: touch;
        }
        
        #timeline-label { font-size: 0.6rem; color: #bbb; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; text-align: center; }

        .entry { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .entry-img { width: 100%; border-radius: 8px; margin-bottom: 10px; }
        .author-tag { font-weight: bold; font-size: 0.7rem; color: var(--accent); }
        
        .comment-section { background: #f6f6f6; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.8rem; }
        .comment-item { margin-bottom: 4px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .comment-author { font-weight: bold; font-size: 0.65rem; color: #777; }
        
        .reply-btn { background: none; border: none; color: var(--link); font-size: 0.75rem; font-weight: bold; cursor: pointer; padding-top: 10px; display: block; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 50px; font-size: 0.7rem; display: none; z-index: 1000; }
    </style>
</head>
<body>

    <div id="toast">Notifying...</div>

    <div id="top-container">
        <div id="header">
            <div id="day-counter">Counting... <span class="heart-pulse" onclick="iamHere()">â™¥</span></div>
            <div style="font-size: 0.5rem; color: #bbb; margin-top: 4px; cursor: pointer;" onclick="resetIdentity()">Settings</div>
        </div>

        <div class="section">
            <div class="mood-grid">
                <div class="mood-box" onclick="quickLog('ðŸ˜Š', 'happy')"><span>ðŸ˜Š</span><p>Happy</p></div>
                <div class="mood-box" onclick="quickLog('ðŸ˜¤', 'mad')"><span>ðŸ˜¤</span><p>Mad</p></div>
                <div class="mood-box" onclick="quickLog('ðŸ«‚', 'miss you')"><span>ðŸ«‚</span><p>Miss You</p></div>
            </div>
        </div>

        <div class="section">
            <div id="viewport">
                <video id="v" autoplay playsinline muted style="display:none;"></video>
                <img id="preview-img" style="display:none;">
                <span id="cam-label" style="color:#666; font-size:0.6rem;">READY</span>
            </div>
            <div class="cam-controls">
                <button class="btn" id="main-cam-btn" onclick="startStream()" style="grid-column: span 2;">Camera</button>
                <button id="snap-btn" class="btn btn-black" style="display:none;" onclick="captureImage()">Snap</button>
                <button id="close-btn" class="btn" style="display:none;" onclick="stopCamera()">X</button>
            </div>
            <textarea id="msg-input" placeholder="Say something..."></textarea>
            <button class="btn btn-black" style="margin-top:8px;" onclick="submitEntry()">Post</button>
        </div>
    </div>

    <div id="timeline">
        <div id="timeline-label">â€”â€” Timeline History â€”â€”</div>
        <div id="list"></div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://alky-bd03f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('alky_timeline');

        (function() { emailjs.init("w-7MpanHNsBrGh6vo"); })();
        const SERVICE_ID = "service_5zrzgge";
        const TEMPLATE_ID = "template_dj834xq";
        const CD_EMAIL = "sarmientoclairedean@gmail.com";
        const NADINE_EMAIL = "aprilsia00@gmail.com";

        let userRole = localStorage.getItem('alky_role');

        window.onload = () => {
            if (!userRole) {
                userRole = confirm("Identity: CD's phone?") ? 'CD' : 'Nadine';
                localStorage.setItem('alky_role', userRole);
            }
            const diffDays = Math.floor((new Date() - new Date("2025-08-12")) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('day-counter').innerHTML = `Day ${diffDays} <span class="heart-pulse" onclick="iamHere()">â™¥</span>`;
            db.on('value', (snap) => renderTimeline(snap.val()));
        };

        function notify(mood) {
            const toast = document.getElementById('toast');
            toast.style.display = 'block'; toast.innerText = "Pinging...";
            const recipient = (userRole === 'CD') ? NADINE_EMAIL : CD_EMAIL;
            emailjs.send(SERVICE_ID, TEMPLATE_ID, { mood: mood, send_to: recipient, time: new Date().toLocaleTimeString() })
            .then(() => { 
                toast.innerText = "Sent to " + (userRole === 'CD' ? "Nadine" : "CD");
                setTimeout(() => toast.style.display = 'none', 2000);
            });
        }

        function iamHere() { notify("I'm here! â™¥"); alert("Heart ping sent!"); }

        function renderTimeline(data) {
            const list = document.getElementById('list');
            list.innerHTML = ''; if (!data) return;

            Object.keys(data).reverse().forEach(key => {
                const item = data[key];
                const div = document.createElement('div');
                div.className = 'entry';
                
                let comms = '';
                if (item.comments) {
                    comms = `<div class="comment-section">`;
                    Object.values(item.comments).forEach(c => {
                        comms += `<div class="comment-item"><span class="comment-author">${c.author}:</span> ${c.text}</div>`;
                    });
                    comms += `</div>`;
                }

                div.innerHTML = `
                    ${item.img ? `<img src="${item.img}" class="entry-img">` : ''}
                    <div>
                        <span class="author-tag">${item.author}</span>
                        <div style="font-size:0.9rem; margin: 4px 0;">${item.mood ? item.mood + ' ' : ''}${item.text || ''}</div>
                        <div style="font-size:0.6rem; color:#bbb;">${item.time || ''}</div>
                        <button class="reply-btn" onclick="addComment('${key}')">Reply</button>
                        ${comms}
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function addComment(postId) {
            const txt = prompt("Comment:");
            if (!txt) return;
            db.child(postId).child('comments').push({ author: userRole, text: txt });
            notify("ðŸ’¬ Comment: " + txt);
        }

        function quickLog(emoji, text) { 
            notify(emoji + " " + text); 
            db.push({ mood: emoji, text: text, author: userRole, time: new Date().toLocaleString() }); 
        }

        function submitEntry() {
            const text = document.getElementById('msg-input').value;
            const img = capturedBase64;
            if (!text && !img) return;
            db.push({ mood: 'ðŸ“¸', text: text, img: img, author: userRole, time: new Date().toLocaleString() });
            notify("ðŸ“¸ New Post");
            document.getElementById('msg-input').value = ""; stopCamera(); capturedBase64 = null; document.getElementById('preview-img').style.display='none';
        }

        const v = document.getElementById('v');
        const previewImg = document.getElementById('preview-img');
        let stream = null; let capturedBase64 = null;

        async function startStream() {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            v.srcObject = stream; v.style.display = 'block';
            document.getElementById('main-cam-btn').style.display = 'none';
            document.getElementById('snap-btn').style.display = 'block';
            document.getElementById('close-btn').style.display = 'block';
        }

        function stopCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            v.style.display = 'none'; document.getElementById('main-cam-btn').style.display = 'block';
            document.getElementById('snap-btn').style.display = 'none'; document.getElementById('close-btn').style.display = 'none';
        }

        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = v.videoWidth; canvas.height = v.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(v, 0, 0);
            capturedBase64 = canvas.toDataURL('image/jpeg', 0.5);
            previewImg.src = capturedBase64; previewImg.style.display = 'block';
            stopCamera();
        }

        function resetIdentity() { localStorage.removeItem('alky_role'); location.reload(); }
    </script>
</body>
</html>
